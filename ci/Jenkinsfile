pipeline{
    agent any
    environment{
        NETLIFY_SITE_ID = credentials('planatory-site-id')
        NETLIFY_AUTH_TOKEN = credentials('netlify-auth')
    }
    options{
        //keep only the last 10 builds
        buildDiscarder(logRotator(numToKeepStr:'10'))
        // disable same jobs running in parallel
        disableConcurrentBuilds()      
        // timeout for whole pipeline in case of some step hanging
        // 300s:5 minute
        timeout(time: 30, unit: 'MINUTES')
    }
    stages{
        stage('NPM INSTALL'){
           
            agent {
                docker {
                    image 'node:24-bullseye'
                    reuseNode true
                }
            }
            steps {
               echo 'Running npm ci...' 
               echo "${env.BRANCH_NAME}"
               sh '''
                    node --version
                    npm --version
                    npm ci
                '''
            }
        }
        stage('BUILD PROJECT'){
            agent {
                docker {
                    image 'node:24'
                    reuseNode true
                }
            }
            environment{
                VITE_NASA_API_KEY = credentials('nasa-api-key')
                VITE_PIC_DAY = 'https://api.nasa.gov/planetary/apod'
            }
            steps{
                echo 'Build process started'
                sh '''
                    set VITE_NASA_API_KEY=${VITE_NASA_API_KEY}
                    set VITE_PIC_DAY=${VITE_PIC_DAY}
                    npm run build
                '''
            }
            
            post{
                success {
                    echo 'Build process completed!'
                }
                failure {
                    echo 'build failed...' 
                }
            }
        }
        stage("DEPLOYMENT"){
             agent{
                docker {
                    image 'node:24'
                    reuseNode true
                }
            }
            steps{
                sh '''
                    npm install netlify-cli
                    node_modules/.bin/netlify deploy --dir=dist --prod
                '''
            }
            post{
                success{
                    echo 'site updated'
                }
                failure{
                    echo 'failed to deploy the site'
                }
            }
        }
    }
}